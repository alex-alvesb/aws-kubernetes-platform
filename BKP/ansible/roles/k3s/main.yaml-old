- name: Update apt
  apt:
    update_cache: yes

- name: Install curl
  apt:
    name: curl
    state: present

- name: Install K3s with public IP SAN
  shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--tls-san {{ ansible_host }}" sh -
  args:
    creates: /usr/local/bin/k3s

- name: Wait for node to be ready
  shell: |
    kubectl get nodes
  register: kubectl_output
  retries: 10
  delay: 10
  until: kubectl_output.rc == 0
